<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/assets/icons/logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Salus - La tua app per la gestione personale della salute"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    
    <!-- PATCH DI EMERGENZA PER FISSARE LE CHIAMATE API -->
    <script type="text/javascript">
      (function() {
        // Sovrascrive XMLHttpRequest per intercettare e correggere gli URL prima delle richieste
        const originalXHROpen = window.XMLHttpRequest.prototype.open;
        window.XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
          // Controllo se è una chiamata API con un percorso duplicato
          if (typeof url === 'string' && url.includes('/api/api/')) {
            console.log('CORREZIONE AUTOMATICA: URL duplicato rilevato:', url);
            // Correggi l'URL sostituendo '/api/api/' con '/api/'
            url = url.replace('/api/api/', '/api/');
            console.log('CORREZIONE AUTOMATICA: URL corretto:', url);
          }
          
          // Gestione speciale per gli URL di autenticazione su wearesalusapp.com
          if (typeof url === 'string' && 
              window.location.hostname === 'www.wearesalusapp.com' && 
              (url.includes('/auth/register') || url.includes('/auth/login'))) {
            // Usa direttamente l'URL del backend
            const directUrl = 'https://salus-backend.onrender.com' + 
                              (url.includes('/auth/register') ? '/auth/register' : '/auth/login');
            console.log('CORREZIONE AUTOMATICA: Usando URL diretto per autenticazione:', directUrl);
            url = directUrl;
          }
          
          // Chiama il metodo originale con l'URL corretto
          return originalXHROpen.call(this, method, url, async, user, password);
        };
        
        // Registra un avviso quando il sito è caricato
        window.addEventListener('load', function() {
          console.log('PATCH DI EMERGENZA: Intercettazione delle chiamate API attivata');
          
          // Dopo 1 secondo, mostra il form di emergenza
          setTimeout(function() {
            const emergencyForm = document.getElementById('emergency-register-form');
            if (emergencyForm) {
              emergencyForm.style.display = 'block';
            }
          }, 1000);
        });
        
        // Funzione per la registrazione di emergenza
        window.emergencyRegister = function(event) {
          event.preventDefault();
          
          const email = document.getElementById('emergency-email').value;
          const password = document.getElementById('emergency-password').value;
          const name = document.getElementById('emergency-name').value;
          
          if (!email || !password) {
            alert('Email e password sono campi obbligatori');
            return;
          }
          
          const statusElement = document.getElementById('emergency-status');
          statusElement.innerHTML = 'Registrazione in corso...';
          
          // SOLUZIONE CORS: Utilizziamo un proxy CORS online per aggirare le restrizioni
          const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
          const targetUrl = 'https://salus-backend.onrender.com/auth/register';
          
          // Primo tentativo: utilizzando un proxy CORS
          fetch(proxyUrl + targetUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest' // Necessario per CORS-Anywhere
            },
            body: JSON.stringify({
              email: email,
              password: password,
              name: name || ''
            })
          })
          .then(response => {
            console.log('Risposta registrazione con proxy:', response);
            
            if (!response.ok) {
              throw new Error('Errore nella registrazione: ' + response.status);
            }
            
            return response.json();
          })
          .then(data => {
            console.log('Registrazione completata (via proxy):', data);
            statusElement.innerHTML = 'Registrazione completata con successo! Reindirizzamento...';
            
            // Salva il token nel localStorage
            if (data.token) {
              localStorage.setItem('token', data.token);
              
              // Reindirizza alla dashboard dopo 2 secondi
              setTimeout(function() {
                window.location.href = '/dashboard';
              }, 2000);
            }
          })
          .catch(error => {
            console.error('Errore durante la registrazione con proxy:', error);
            statusElement.innerHTML = 'Tentativo alternativo in corso...';
            
            // Secondo tentativo: utilizzando no-cors (non possiamo leggere la risposta ma potrebbe funzionare)
            fetch('https://salus-backend.onrender.com/auth/register', {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                email: email,
                password: password,
                name: name || ''
              })
            })
            .then(response => {
              console.log('Risposta registrazione con no-cors:', response);
              statusElement.innerHTML = 'Richiesta inviata. Poiché non possiamo verificare la risposta, prova ad accedere con le credenziali appena create.';
              
              // Mostra bottone per tentare il login
              const loginButton = document.createElement('button');
              loginButton.innerHTML = 'Vai al Login';
              loginButton.style.marginTop = '10px';
              loginButton.addEventListener('click', function() {
                window.location.href = '/login';
              });
              statusElement.appendChild(document.createElement('br'));
              statusElement.appendChild(loginButton);
            })
            .catch(backupError => {
              console.error('Errore anche nel tentativo con no-cors:', backupError);
              
              // Terzo tentativo: utilizzando un form di sottomissione invisibile
              statusElement.innerHTML = 'Tentativo finale in corso...';
              
              // Crea un form invisibile che invia i dati direttamente al backend
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = 'https://salus-backend.onrender.com/auth/register';
              form.target = '_blank'; // Apre in una nuova tab
              form.style.display = 'none';
              
              // Aggiungi i campi al form
              const emailField = document.createElement('input');
              emailField.type = 'hidden';
              emailField.name = 'email';
              emailField.value = email;
              form.appendChild(emailField);
              
              const passwordField = document.createElement('input');
              passwordField.type = 'hidden';
              passwordField.name = 'password';
              passwordField.value = password;
              form.appendChild(passwordField);
              
              const nameField = document.createElement('input');
              nameField.type = 'hidden';
              nameField.name = 'name';
              nameField.value = name || '';
              form.appendChild(nameField);
              
              // Aggiungi il form al documento e sottomettilo
              document.body.appendChild(form);
              
              statusElement.innerHTML = 'Tentativo finale: si aprirà una nuova finestra per completare la registrazione.<br><small>Una volta completata, torna qui e vai alla pagina di login.</small>';
              
              // Aggiungi un pulsante per inviare manualmente il form
              const submitButton = document.createElement('button');
              submitButton.innerHTML = 'Completa Registrazione';
              submitButton.style.marginTop = '10px';
              submitButton.addEventListener('click', function() {
                form.submit();
                
                // Dopo l'invio del form, mostra il pulsante per andare al login
                const loginRedirectButton = document.createElement('button');
                loginRedirectButton.innerHTML = 'Vai al Login';
                loginRedirectButton.style.marginTop = '10px';
                loginRedirectButton.addEventListener('click', function() {
                  window.location.href = '/login';
                });
                
                statusElement.innerHTML = 'Una volta completata la registrazione nella nuova finestra, torna qui e vai al login.';
                statusElement.appendChild(document.createElement('br'));
                statusElement.appendChild(loginRedirectButton);
              });
              
              statusElement.appendChild(document.createElement('br'));
              statusElement.appendChild(submitButton);
            });
          });
        };
        
        // Funzione per chiudere il form di emergenza
        window.closeEmergencyForm = function() {
          const emergencyForm = document.getElementById('emergency-register-form');
          if (emergencyForm) {
            emergencyForm.style.display = 'none';
          }
        };
      })();
    </script>
    
    <style>
      /* Stili per il form di registrazione di emergenza */
      #emergency-register-form {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        width: 320px;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      #emergency-register-form h2 {
        margin-top: 0;
        color: #4A90E2;
        margin-bottom: 20px;
      }
      #emergency-register-form .form-group {
        margin-bottom: 15px;
      }
      #emergency-register-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      #emergency-register-form input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      #emergency-register-form button {
        background-color: #4A90E2;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        margin-top: 10px;
      }
      #emergency-register-form button:hover {
        background-color: #3A80D2;
      }
      #emergency-register-form .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #888;
        padding: 0;
        width: auto;
        margin: 0;
      }
      #emergency-status {
        margin-top: 15px;
        padding: 8px;
        font-size: 14px;
        background-color: #f8f9fa;
        border-radius: 4px;
        text-align: center;
      }
    </style>
    
    <title>Salus Health App</title>
    <style>
      /* Stili di base - per evitare FOUC */
      body {
        margin: 0;
        padding: 0;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #f8f9fa;
        color: #333;
      }
      
      code {
        font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New', monospace;
      }
      
      #root {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      /* Preloader per migliorare l'UX durante il caricamento */
      .app-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f8f9fa;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
      }
      
      .loader-logo {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        animation: pulse 1.5s infinite;
      }
      
      .loader-text {
        font-size: 18px;
        color: #4A90E2;
        margin-top: 10px;
      }
      
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      /* Modalità dark */
      body.dark-mode {
        background-color: #121212;
        color: #e0e0e0;
      }
      
      body.dark-mode .app-loader {
        background-color: #121212;
      }
    </style>
  </head>
  <body>
    <noscript>È necessario abilitare JavaScript per eseguire questa app.</noscript>
    
    <!-- Form di registrazione di emergenza -->
    <div id="emergency-register-form">
      <button class="close-button" onclick="window.closeEmergencyForm()">×</button>
      <h2>Registrazione di emergenza</h2>
      <form onsubmit="window.emergencyRegister(event)">
        <div class="form-group">
          <label for="emergency-name">Nome (opzionale)</label>
          <input type="text" id="emergency-name" placeholder="Il tuo nome">
        </div>
        <div class="form-group">
          <label for="emergency-email">Email</label>
          <input type="email" id="emergency-email" placeholder="La tua email" required>
        </div>
        <div class="form-group">
          <label for="emergency-password">Password</label>
          <input type="password" id="emergency-password" placeholder="La tua password" required>
        </div>
        <button type="submit">Registrati</button>
      </form>
      <div id="emergency-status"></div>
    </div>
    
    <div id="root"></div>
  </body>
</html> 